// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int          @default(autoincrement()) @id
  email       String       @unique
  password    String
  name        String?
  age         Int?
  posts       Post[]
  roles       Role[]       @relation("UserRoles")
  permissions Permission[] @relation("UserPermissions")  // 用户与权限的多对多关系
  applications Application[] // 用户创建的应用
}

model Post {
  id        Int      @default(autoincrement()) @id
  title     String
  content   String?
  published Boolean? @default(false)
  author    User?    @relation(fields: [authorId], references: [id])
  authorId  Int?
}

model Role {
  id          Int          @default(autoincrement()) @id
  name        String       @unique
  users       User[]       @relation("UserRoles")    // 角色与用户的多对多关系
  permissions Permission[] @relation("RolePermissions")  // 角色与权限的多对多关系
}

model Permission {
  id          Int          @default(autoincrement()) @id
  name        String       @unique
  description String?
  resource    String       // 资源路径，对应 API 的路径
  action      Action       // 动作，表示 API 请求的动作
  users       User[]       @relation("UserPermissions")  // 权限与用户的多对多关系
  roles       Role[]       @relation("RolePermissions")  // 权限与角色的多对多关系
}

enum Action {
  GET        // 对应 HTTP GET 请求，获取资源
  POST       // 对应 HTTP POST 请求，创建资源
  PUT        // 对应 HTTP PUT 请求，更新资源（覆盖）
  DELETE     // 对应 HTTP DELETE 请求，删除资源
  PATCH      // 对应 HTTP PATCH 请求，部分更新资源
  OPTIONS    // 对应 HTTP OPTIONS 请求，获取资源支持的请求方法
  HEAD       // 对应 HTTP HEAD 请求，获取资源的元数据（不返回响应体）
  TRACE      // 对应 HTTP TRACE 请求，跟踪请求-响应链
  CONNECT    // 对应 HTTP CONNECT 请求，用于启动双向的通信通道（通常用于隧道协议）
}

// 低代码平台模型

model Application {
  id          Int       @default(autoincrement()) @id
  name        String    // 应用名称
  description String?   // 应用描述
  creator     User      @relation(fields: [creatorId], references: [id])
  creatorId   Int
  pages       Page[]    // 应用包含的页面
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Page {
  id            Int         @default(autoincrement()) @id
  title         String      // 页面标题
  path          String      // 页面路径
  application   Application @relation(fields: [applicationId], references: [id])
  applicationId Int
  components    Json        // 存储页面的组件树结构
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([applicationId, path])  // 确保同一应用中页面路径唯一
}
